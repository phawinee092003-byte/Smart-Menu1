<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Menu - Digital Menu</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js"></script>

    <style>
        .search-container { padding: 15px 7%; background: #fff; display: flex; justify-content: center; }
        .search-box { width: 100%; max-width: 500px; padding: 12px 20px; border: 2px solid #eee; border-radius: 30px; font-family: 'Prompt', sans-serif; outline: none; transition: 0.3s; }
        .search-box:focus { border-color: #ff4757; box-shadow: 0 0 10px rgba(255, 71, 87, 0.1); }
        .price-tag { color: #ff4757; font-weight: 600; font-size: 1.3rem; }
        
        .ar-btn {
            width: 100%; padding: 10px; background: #2d3436; color: #fff; border: none;
            border-radius: 8px; margin-top: 10px; cursor: pointer; font-family: 'Prompt';
            display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.3s;
        }

        .btn-close-ar {
            position: fixed !important;
            top: 30px !important;
            right: 20px !important;
            z-index: 999999 !important;
            background: #ff4757 !important;
            color: white !important;
            border: none !important;
            padding: 15px 30px !important;
            border-radius: 50px !important;
            font-weight: bold !important;
            font-family: 'Prompt', sans-serif !important;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5) !important;
            cursor: pointer !important;
        }

        model-viewer {
            width: 100%;
            height: 100%;
            background-color: #000;
        }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="logo">Smart<span>Menu</span></div>
        <div class="dropdown">
            <button class="dropbtn" onclick="toggleDropdown()">
                üåê <span id="current-lang-label">‡πÑ‡∏ó‡∏¢</span>
            </button>
            <div id="langDropdown" class="dropdown-content">
                <a href="#" onclick="changeLanguage('th', '‡πÑ‡∏ó‡∏¢')">‡πÑ‡∏ó‡∏¢</a>
                <a href="#" onclick="changeLanguage('en', 'English')">English</a>
                <a href="#" onclick="changeLanguage('jp', 'Êó•Êú¨Ë™û')">Êó•Êú¨Ë™û</a>
                <a href="#" onclick="changeLanguage('cn', '‰∏≠Êñá')">‰∏≠Êñá</a>
            </div>
        </div>
    </nav>

    <div class="search-container">
        <input type="text" id="menuSearch" class="search-box" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£..." onkeyup="searchMenu()">
    </div>

    <div class="category-container">
        <div class="category-scroll">
            <button class="cat-btn active" onclick="filterMenu('thai', this)">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢</button>
            <button class="cat-btn" onclick="filterMenu('western', this)">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ù‡∏£‡∏±‡πà‡∏á</button>
            <button class="cat-btn" onclick="filterMenu('indian', this)">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏≠‡∏¥‡∏ô‡πÄ‡∏î‡∏µ‡∏¢</button>
            <button class="cat-btn" onclick="filterMenu('dessert', this)">‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô</button>
            <button class="cat-btn" onclick="filterMenu('drink', this)">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</button>
        </div>
    </div>

    <main id="menu-grid" class="menu-grid"></main>

    <div id="arModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:100000;">
        <button class="btn-close-ar" onclick="closeAR()">‡∏õ‡∏¥‡∏î (Close)</button>
        
        <model-viewer 
            id="foodViewer" 
            src="" 
            ios-src="" 
            draco-decoder-path="https://www.gstatic.com/draco/v1/decoders/"
            ar 
            ar-modes="webxr scene-viewer quick-look" 
            camera-controls 
            shadow-intensity="1" 
            exposure="1.2"
            scale="0.3 0.3 0.3">
        </model-viewer>
    </div>

    <script>
        const translations = {
            th: { view_ar: "‡∏î‡∏π‡∏†‡∏≤‡∏û 3D / ‡∏ß‡∏≤‡∏á‡∏ö‡∏ô‡πÇ‡∏ï‡πä‡∏∞", allergy: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡πâ", search_placeholder: "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£..." },
            en: { view_ar: "View 3D / AR", allergy: "Allergy Info", search_placeholder: "Search menu..." },
            jp: { view_ar: "3D/AR„ÅßË¶ã„Çã", allergy: "„Ç¢„É¨„É´„ÇÆ„ÉºÊÉÖÂ†±", search_placeholder: "„É°„Éã„É•„Éº„ÇíÊ§úÁ¥¢..." },
            cn: { view_ar: "Êü•Áúã 3D/AR", allergy: "ËøáÊïèÂéü‰ø°ÊÅØ", search_placeholder: "ÊêúÁ¥¢ËèúÂçï..." }
        };

        const foodData = {
            thai: [
                { 
                    name: {th: "‡∏ï‡πâ‡∏°‡∏¢‡∏≥‡∏Å‡∏∏‡πâ‡∏á", en: "Tom Yum Goong", jp: "„Éà„É†„É§„É†„ÇØ„É≥", cn: "ÂÜ¨Èò¥Âäü"}, 
                    desc: {th: "‡∏ã‡∏∏‡∏õ‡∏™‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£‡πÑ‡∏ó‡∏¢‡∏£‡∏™‡∏à‡∏±‡∏î‡∏à‡πâ‡∏≤‡∏ô", en: "Spicy and sour Thai soup.", jp: "„Çπ„Éë„Ç§„Ç∑„Éº„Å™„Çπ„Éº„Éó", cn: "ÈÖ∏Ëæ£Ê±§"}, 
                    price: 280, 
                    allergy: {th: "‡∏Å‡∏∏‡πâ‡∏á, ‡∏õ‡∏•‡∏≤", en: "Shrimp, Fish", jp: "Êµ∑ËÄÅ„ÄÅÈ≠ö", cn: "Ëôæ„ÄÅÈ±º"},
                    image: "https://www.mfoodservice.com/images/admin/img/42.png",
                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏à‡∏£‡∏¥‡∏á
                    model_glb: "/static/models/tomyumarcore.glb", 
                    model_ios: "/static/models/tomyumarkit (1).glb"
                }
            ],
            western: [], indian: [], dessert: [], drink: []
        };

        let currentLang = 'th';
        let currentCat = 'thai';

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ß‡∏±‡∏™‡∏î‡∏∏‡πÉ‡∏´‡πâ‡∏ó‡∏∂‡∏ö‡πÅ‡∏™‡∏á‡πÅ‡∏•‡∏∞‡∏™‡∏°‡∏à‡∏£‡∏¥‡∏á
        function applyMaterialFix(viewerElement) {
            const model = viewerElement.model;
            if (model) {
                model.materials.forEach(material => {
                    material.setAlphaMode("OPAQUE");
                    material.setDoubleSided(true);
                    if (material.pbrMetallicRoughness) {
                        material.pbrMetallicRoughness.setRoughnessFactor(0.6); // ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏á‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏ô‡πà‡∏≤‡∏Å‡∏¥‡∏ô
                        material.pbrMetallicRoughness.setMetalnessFactor(0.1); // ‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏∞‡∏ó‡πâ‡∏≠‡∏ô‡πÇ‡∏•‡∏´‡∏∞
                    }
                });
            }
        }

        const viewer = document.getElementById('foodViewer');
        viewer.addEventListener('load', () => applyMaterialFix(viewer));

        function toggleDropdown() { document.getElementById("langDropdown").classList.toggle("show"); }

        function changeLanguage(lang, label) {
            currentLang = lang;
            document.getElementById('current-lang-label').innerText = label;
            document.getElementById('menuSearch').placeholder = translations[lang].search_placeholder;
            renderCards();
        }

        function filterMenu(cat, btn) {
            currentCat = cat;
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderCards();
        }

        function searchMenu() {
            const searchText = document.getElementById('menuSearch').value.toLowerCase();
            renderCards(searchText);
        }

        function openAR(glbUrl, iosUrl) {
            const viewer = document.getElementById('foodViewer');
            document.getElementById('arModal').style.display = 'block';
            viewer.src = glbUrl; // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Android
            viewer.iosSrc = iosUrl; // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö iOS
            document.body.style.overflow = 'hidden';
            setTimeout(() => applyMaterialFix(viewer), 500);
        }

        function closeAR() {
            document.getElementById('arModal').style.display = 'none';
            document.getElementById('foodViewer').src = '';
            document.getElementById('foodViewer').iosSrc = ''; 
            document.body.style.overflow = 'auto';
        }

        function renderCards(filterText = "") {
            const grid = document.getElementById('menu-grid');
            grid.innerHTML = '';
            const items = foodData[currentCat] || [];
            const currency = { th: "‡∏ø", en: "$", jp: "¬•", cn: "¬•" };

            items.filter(item => item.name[currentLang].toLowerCase().includes(filterText.toLowerCase())).forEach(item => {
                let displayPrice = item.price;
                if (currentLang === 'en') displayPrice = (item.price / 35).toFixed(2);
                
                grid.innerHTML += `
                    <div class="menu-card">
                        <img src="${item.image}" class="menu-img">
                        <div class="menu-info">
                            <div style="display: flex; justify-content: space-between;">
                                <h3>${item.name[currentLang]}</h3>
                                <span class="price-tag">${currency[currentLang]}${displayPrice}</span>
                            </div>
                            <p>${item.desc[currentLang]}</p>
                            <button class="ar-btn" onclick="openAR('${item.model_glb}', '${item.model_ios}')">üï∂Ô∏è ${translations[currentLang].view_ar}</button>
                            <div style="margin-top:5px; font-size:0.8rem; color:#666;">
                                ‚ö†Ô∏è ${translations[currentLang].allergy}: ${item.allergy[currentLang]}
                            </div>
                        </div>
                    </div>`;
            });
        }

        window.onclick = function(event) {
            if (!event.target.matches('.dropbtn')) {
                const dropdowns = document.getElementsByClassName("dropdown-content");
                for (let i = 0; i < dropdowns.length; i++) {
                    if (dropdowns[i].classList.contains('show')) dropdowns[i].classList.remove('show');
                }
            }
        }

        renderCards();
    </script>
</body>
</html>